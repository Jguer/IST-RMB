<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>RCI Message Board: src/doc_tech_server.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RCI Message Board
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">https://github.com/Jguer/RCI-Message-Board</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">src/doc_tech_server.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="doc__tech__server_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Server Application Technical Specs {#Technical_S}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;------------------------------------</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;When the application is called in the command line it can have various arguments:\n</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;Non-Optional\n</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;&gt; n [name] -&gt; Intended name for the server\n</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;&gt; j [ip address] -&gt; IP address for the server. Must be the ip of the machine\n</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;&gt; u [UDP port] -&gt; Port for udp incoming connections. Must be free port.\n</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;&gt; t [TCP port] -&gt; Port for tcp incoming connections. Must be free port.\n</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Optional\n</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;&gt; i [ip address] -&gt; IP address of the identity server.\n Default: tejo.tecnico.ulisboa.pt\n</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;&gt; p [port of address] -&gt; Port of the identity server on that IP address.\n Default: 59000\n</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;&gt; m [max. messages] -&gt; Maximum number of messages that the server can save.\n Default: 200\n</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;&gt; r [register interval] -&gt; Time (in seconds) between registers to the id server.\n Default:10s\n</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;Program work flow (#server_workflow)</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;====================================</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;- Parse terminal arguments</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;- Get id server address to check if it exists:</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;- Initiates the program fundamental variables</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    + Initialize sockets (\ref file_descriptors_server)</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    + Initializes the timer implementation</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;- Enters a interactive loop where the program will run until it finds an error or is told to exit.</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    + Sends all the file descriptors (fd) to a set, the set will be watched and each fd will be handled only when its ready (The communications only start after the user asks to join, and returns successful).</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    + The program will wait in the select function until one of the [file descriptors](\ref file_descriptors_server) is ready to be read.</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    + The registration to id server is refreshed, if the time as elapsed.</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    + If a server tries to connect it is accepted and saved in a list. See [incoming request to connect](\ref incom_tcp_req)</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    + If an incoming udp message is received the incoming message is handled. See [udp handling](\ref udp_handle_server).</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    + If the user sends input to console the command must be interpreted. See [user input handling](\ref user_input_server).</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        * User join command is where this program starts the main routines.</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        * Join sends the first register to the id server. Gets the already present servers and verifies if this server is registered. Then proceeds to open communications to the already joined servers, where it ask for the messages to just one server (The first that answers the request).</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        * The other options just print the current info of the messages and connected servers. Or exit.</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    + If theres an incoming tcp message from a already connected server it is treated accordingly. See [tcp handling](\ref tcp_handle_server).</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    + Reprints the prompt if its necessary.</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    + Loop restarts.</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;- Free all allocated memory and exit.</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;File descriptors{#file_descriptors_server}</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;=========================================</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;- STDIN: This file descriptor is used to read from the user and is only ready when the user send input to the terminal.</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;- UDP:</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    + Global fd: This socket is binded to a port in the system, so that the clients can communicate to a well known port and the select function can process the file descriptor, it is used just to receive and send information to clients.</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    + Outgoing fd: This socket is only used to ask for servers from the identity server and register.</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;- TIMER: (Library: timer_fd.h) This timer is implemented via a file descriptor. When the timer is triggered the file descriptor is set as ready to read.</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;- TCP:</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    + Listen fd: Listen_fd receives incoming connections who latter will be answered and communicate via another file descriptor (server_fd)</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    + Server fd: There can be many file descriptors of this in the program. Any server who is connected tho this server will have it&#39;s own file descriptor, who is saved in their own server struct.</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    + </div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;The file descriptors are handled with the select() function who blocks until one of the file descriptors signals that it is ready to read. This function control the work flow of the program.</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;Incoming requests to connect {#incom_tcp_req}</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;============================================</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;When a server tries to connect it is put on a queue of 5 servers capacity.\n</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;This routine accepts the connection, and saves that server info on a list dedicated to server struct items.</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;This items contain the server name, ip address, tcp port and the corresponding file descriptor.</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;Theres a udp port slot, who is unused. This structure is shared between client and server.</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;Every incoming server has is name set to Inbound Server.</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;UDP incoming messages treatment {#udp_handle_server}</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;=====================================================</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;The server is projected to only be able to receive two type of message from the clients. The messages can have one of two headers: `&#39;PUBLISH message&#39;` or `&#39;GET_MESSAGES n&#39;`.</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;First thing to do is allocate some space in memory to save our incoming communication, being sent via UDP, the message arrives all at once and the buffer needs to have size for the entire communication.\n</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;The size is the size of &#39;PUBLISH&#39; plus the size of the whole message (140 char. max). All that is received with more size than the size who was allocated is lost.</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;After receiving the information, it is saved in a message struct, in the case of &#39;PUBLISH&#39; being the header, the logical clock is set to the next logical clock. (eg. if LastMessageLC == 1 so NewMessageLC = 2)</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;If &#39;GET_MESSAGES n&#39; is received, the last n messages are fetched from the matrix and sent to the client who made the request. If n is bigger than the number of messages present, only the present messages are sent to the user.</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;User input interpretation {#user_input_server}</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;===============================================</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;The commands that the user can input are:</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;These are not case-sensitive and there are numeric shortcuts.</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;Command                       |Shortcut</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;:-----------------------------|:-------:</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;join                          | 1</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;show\_servers                 | 2</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;show\_messages                | 3</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;exit                          | 9</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;Join command starts the communications to other servers and enables client communications.\n</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;The show_servers command prints the list currently being used to select the server at work.\n</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;The show_messages command prints the matrix currently being used to save messages.\n</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;Exit command breaks out of the loop.</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;TCP handling {#tcp_handle_server}</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;=====================================================</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;Server to server communications are based in two types of headers: `&#39;SMESSAGES\n(message\n)\n&#39;` or `&#39;SGET_MESSAGES\n&#39;`.</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;The parsing of information is made at the rate of the incoming bytes from the recv command, and split in &#39;\n&#39; sequences. </div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;The former is interpreted as a command to save the messages.</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;The later requests all the messages that this server has.</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;After receiving the information, it is saved in a message struct, in the case of &#39;SMESSAGES&#39; being the header, the logical clock is set to the next logical clock of the MAX between LastMessageLC and IncomingMessageLC. (eg. if LastMessageLC == 20 and IncomingMessageLC == 5 so NewMessageLC = 21)</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;If &#39;SGET_MESSAGES&#39; is received, the messages are fetched from the matrix and sent to the server who made the request.</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
