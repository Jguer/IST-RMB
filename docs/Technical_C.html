<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>RCI Message Board: Client Technical Details</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">RCI Message Board
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">https://github.com/Jguer/RCI-Message-Board</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Client Technical Details </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Client Application Technical Specs </h2>
<p>When the application is called in the command line it can have two optional arguments: </p>
<blockquote class="doxtable">
<p>i [ip address] -&gt; IP address of the identity server<br/>
 Default: tejo.tecnico.ulisboa.pt<br/>
p [port of address] -&gt; Port of the identity server on that IP address<br/>
 Default: 59000<br/>
 </p>
</blockquote>
<h1>Program work flow (#client_workflow) </h1>
<ul>
<li>Parse terminal arguments</li>
<li>Get id server address to check if it exists:</li>
<li>Initiates the program fundamental variables (See <a class="el" href="rmb_2identity_8c.html#a7cba927f7fd909e390da7e59fa557862" title="Initiates the program variables. ">init_program()</a>)<ul>
<li>Initialize sockets (<a class="el" href="Technical_C.html#file_descriptors_client">File descriptors</a>)</li>
<li>Initializes the timer implementation</li>
<li>Fetch servers from the identity server</li>
<li>Saves the servers in the list of message servers</li>
<li>Selects one of the servers to communicate with</li>
</ul>
</li>
<li>Enters a interactive loop where the program will run until it finds an error or is told to exit.<ul>
<li>Sends all the file descriptors (fd) to a set, the set will be watched and each fd will be handled only when its ready.</li>
<li>If no server is selected, a specific error occurred or a selected server isn't answering we must get a new and valid one, only then the program proceeds. To better understand how we handled the matters with bad servers and functional ones see <a class="el" href="Technical_C.html#server_validity_check">Server Validity Check</a>.</li>
<li>The program will wait in the select function until one of the <a class="el" href="Technical_C.html#file_descriptors_client">file descriptors</a> is ready to be read.</li>
<li>If the timer ticks the <a class="el" href="Technical_C.html#server_validity_check">test for server validity</a> is handled.</li>
<li>If an incoming udp message is received the incoming message is handled. See <a class="el" href="Technical_C.html#udp_handle_client">udp handling</a>.</li>
<li>If the user sends input to console the command must be interpreted. See <a class="el" href="Technical_C.html#user_input_client">user input handling</a>.</li>
<li>Strings are cleaned (filled with '\0'), and prompt is reprinted.</li>
<li>Loop restarts.</li>
</ul>
</li>
<li>Free all allocated memory and exit.</li>
</ul>
<h1><a class="anchor" id="file_descriptors_client"></a>
File descriptors</h1>
<ul>
<li>STDIN: This file descriptor is used to read from the user and is only ready when the user send input to the terminal.</li>
<li>UDP:<ul>
<li>Binded fd: This socket is binded to a port in the system, so that the servers can communicate to a well known port and the select function can process the file descriptor</li>
<li>Outgoing fd: This socket is only used to ask for servers from the identity server</li>
</ul>
</li>
<li>TIMER: (Library: timer_fd.h) This timer is implemented via a file descriptor. When the timer is triggered the file descriptor is set as ready to read.</li>
</ul>
<p>The file descriptors are handled with the select() function.</p>
<h1><a class="anchor" id="server_validity_check"></a>
Server Validity Check </h1>
<h3>The if block</h3>
<p>In order to explain better the work that is done in this block, there is a need to know how the server ban implementation works. It's based in two major calls: </p>
<blockquote class="doxtable">
<p><a class="el" href="ban_8h.html#a4b11ff16806417cdb6aa6101696639b3" title="ban_server Puts the server to ban in a list if it&#39;s not in there already, if it is, reset the counter ">ban_server(list, server)</a> - Puts the server in a list of servers who are banned, and sets it's ban time to a specified time. If it already exists restore the ban time to the specified time.<br/>
<a class="el" href="ban_8h.html#a367af9dc0d0890456065dc4925e47dc9" title="ban_server Checks if the server is banned, if it is return true, else false; ">is_banned(list, server)</a> - Checks if server is banned, returns true if it's banned and false if not. The ban time counter on that server is decreased.<br/>
 </p>
</blockquote>
<p>If a server is not answering the server is banned and removed from the messages servers list. Then starts the look for a new server that is not banned, if we find one that is already banned it is removed from the message servers list. Until we find a non banned server or there aren't no servers left in the list.</p>
<p>On the end of the block one of two cases will happen:</p>
<ul>
<li>1: We find a server and exit the block with that server.</li>
<li>2: The list is empty and new servers list is fetched from the identity server and the block restarts to check the fetched servers.</li>
</ul>
<p>If the servers fetched are still the same after every fetch the banned servers will became unbanned eventually and can be used after that. </p>
<hr/>
 <h3>The test</h3>
<p>The program only uses the block after errors on sending outgoing communications to servers.<br/>
If there isn't a server selected to work.<br/>
Or if the server didn't passed the test in the specified time.</p>
<p>Now how does the program states that the server is not working. After each user request to the server a test is performed. Based on the <a class="el" href="rmb_2message_8c.html#a14d1d63c17c0a13be1cb36ea36acf165" title="ask_for_messages sends a UDP request to sel_server for the last num messages. ">ask_for_messages()</a> call, we can determine if the server is answering or not.</p>
<p>So after a <a class="el" href="rmb_2message_8c.html#aeb215bbf184aff405e3dcc5bb7f0af82" title="publish sends a msg with 140 characters max to sel_server. ">publish()</a> is called to perform a user request a <a class="el" href="rmb_2message_8c.html#a14d1d63c17c0a13be1cb36ea36acf165" title="ask_for_messages sends a UDP request to sel_server for the last num messages. ">ask_for_messages()</a> is also called with a parameter who sets the no need to print the answer when it comes. In the mean time the test is scheduled with a call to <a class="el" href="rmb_2message_8c.html#a616553a160a98fb768d65429fd3b8152" title="ask_server_test marks the test to happen ">ask_server_test()</a> and a internal flag is set.<br/>
The timer is responsible to check whether the server answered or not.</p>
<p>Every time the timer is triggered the function <a class="el" href="rmb_2message_8c.html#a4f67b45512ddca87beb2601e00855627" title="exec_server_test returns server state: 0 working, 1 not working, 2 still testing ">exec_server_test()</a> is called and if <a class="el" href="rmb_2message_8c.html#a616553a160a98fb768d65429fd3b8152" title="ask_server_test marks the test to happen ">ask_server_test()</a> was called the "counter" inside <a class="el" href="rmb_2message_8c.html#a4f67b45512ddca87beb2601e00855627" title="exec_server_test returns server state: 0 working, 1 not working, 2 still testing ">exec_server_test()</a> is incremented, if it happened two times the server is considered not_answering.</p>
<p>If a server answers with a valid response, the flag is reset and the next timer trigger will clean the test and the server is not marked as unresponsive.</p>
<p>To test after a user call to <a class="el" href="rmb_2message_8c.html#a14d1d63c17c0a13be1cb36ea36acf165" title="ask_for_messages sends a UDP request to sel_server for the last num messages. ">ask_for_messages()</a> the same is done, only the parameter who states if the result is to print or not is set to print output.</p>
<h1><a class="anchor" id="udp_handle_client"></a>
Udp incoming messages treatment </h1>
<p>The client is projected to only be able to receive one type of message from the messages servers. the messages carries one header: <code>'MESSAGES\n'</code> and can contain multiple lines after that containing info on each message.</p>
<p>First thing to do is allocate some space in memory to save our incoming communication, being sent via UDP, the message arrives all at once and the buffer needs to have size for the entire communication.<br/>
The size is calculated knowing the number of messages that were requested to the server. If the server sends more, some info may be lost.</p>
<p>After receiving the information, it is printed to the user. With a little aesthetic modification.</p>
<h1><a class="anchor" id="user_input_client"></a>
User input interpretation </h1>
<p>The commands that the user can input are: These are not case-sensitive and there are numeric shortcuts. </p>
<table class="doxtable">
<tr>
<th align="left">Command </th><th align="center">Shortcut  </th></tr>
<tr>
<td align="left">show_servers </td><td align="center">0 </td></tr>
<tr>
<td align="left">publish <b>message</b> </td><td align="center">1 </td></tr>
<tr>
<td align="left">show_latest_messages <b>n</b> </td><td align="center">2 </td></tr>
<tr>
<td align="left">show_selected_server </td><td align="center">3 </td></tr>
<tr>
<td align="left">exit </td><td align="center">9 </td></tr>
</table>
<p>To interpret the user request the function <code>scanf("%s%*[ ]%140[^\\t\\n]", a, b)</code> is called.<br/>
The first word until it finds a white-space is saved in 'a'.<br/>
Then we throw away the white-space.<br/>
And finally the next 140 characters, if not found tab or new-line, are saved in 'b'.<br/>
For comparing the commands with the user_input strcasecmp() is used to compare without case sensitive characters.</p>
<p>If the user inputs a message with more than 140 characters, the remaining is discarded.<br/>
The user is asked if he really wants to send the sliced message, if the operation in 'a' is publish.<br/>
See <a class="el" href="rmb_2message_8c.html#aeb215bbf184aff405e3dcc5bb7f0af82" title="publish sends a msg with 140 characters max to sel_server. ">publish()</a> to know more on how are messages sent.<br/>
See <a class="el" href="rmb_2message_8c.html#a14d1d63c17c0a13be1cb36ea36acf165" title="ask_for_messages sends a UDP request to sel_server for the last num messages. ">ask_for_messages()</a> to see how the requests are made.</p>
<p>The show_servers command prints the list currently being used to select the server at work.<br/>
Exit command breaks out of the loop. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
